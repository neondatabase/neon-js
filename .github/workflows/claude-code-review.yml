name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Only trusted authors for auto-runs; manual runs always allowed
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.draft == false &&
       contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.pull_request.author_association))

    runs-on:
      group: neondatabase-protected-runner-group
      labels: linux-ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/pull/{0}/head', github.event.inputs.pr_number) || '' }}

      - name: Load project context
        id: claude-md
        run: |
          content=$(cat CLAUDE.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: '--allowed-tools "Bash(gh:*)"'
          prompt: |
            # Multi-Perspective Code Review

            **REPO:** ${{ github.repository }}
            **PR:** #${{ github.event.pull_request.number || github.event.inputs.pr_number }}
            **COMMIT:** ${{ github.event.pull_request.head.sha || github.sha }}

            ## Project Context (from CLAUDE.md)
            <claude_md>
            ${{ steps.claude-md.outputs.content }}
            </claude_md>

            ## Severity Definitions

            - ðŸ”´ **Critical**: Security vulnerability, data loss risk, or guaranteed runtime error
            - ðŸŸ¡ **Important**: Correctness issue, poor UX, or maintainability concern
            - ðŸ”µ **Consider**: Optimization opportunity or best practice suggestion

            ## Comment Guidelines

            - Max 5 comments TOTAL per file (not per expert)
            - Priority: ðŸ”´ Critical > ðŸŸ¡ Important > ðŸ”µ Consider
            - Skip issues automated tools catch (lint, format, types)

            ## Review Process

            Analyze this PR through 5 expert perspectives:

            ---

            ### 1. Security Auditor

            You are an expert in authentication security, OWASP patterns, and secure coding practices.

            **IN Scope:**
            - Authentication/authorization flows
            - JWT handling (validation, expiry, algorithm)
            - Cookie security (HttpOnly, Secure, SameSite)
            - OAuth flows (redirect validation, state parameter)
            - Session lifecycle (creation, refresh, invalidation)
            - Input validation and sanitization
            - CSRF/XSS prevention

            **OUT of Scope:**
            - Code style, performance optimization
            - Framework-specific patterns (that's Integration Expert)
            - Type definitions

            **Checklist:**
            - [ ] No secrets/credentials in source code
            - [ ] JWT tokens validated server-side (not just decoded)
            - [ ] Session cookies use HttpOnly + Secure + SameSite
            - [ ] OAuth callbacks validate redirect URIs
            - [ ] postMessage handlers verify origin
            - [ ] Sensitive data not logged or exposed in errors
            - [ ] Rate limiting on auth endpoints
            - [ ] CSRF tokens on state-changing operations

            **Anti-Patterns:**
            - ðŸ”´ JWT decoded without signature verification
            - ðŸ”´ Cookies without HttpOnly/Secure flags
            - ðŸ”´ postMessage without origin check
            - ðŸ”´ User input in SQL/HTML without sanitization
            - ðŸŸ¡ Session not invalidated on sign-out
            - ðŸŸ¡ Missing rate limiting on login attempts

            ---

            ### 2. SDK Public API Guardian

            You ensure the SDK maintains backward compatibility, proper versioning, and clean public interfaces.

            **IN Scope:**
            - Public exports (`exports` field in package.json)
            - Breaking changes to function signatures
            - Type exports and inference
            - Peer dependency changes
            - Semver compliance
            - Documentation completeness (JSDoc)

            **OUT of Scope:**
            - Internal implementation details
            - Security concerns
            - Test code

            **Checklist:**
            - [ ] No removed exports without major version bump
            - [ ] Input types only widened (accept more), not narrowed
            - [ ] Output types only narrowed (return less), not widened
            - [ ] Peer dependencies not bumped without changelog entry
            - [ ] All public functions have JSDoc with @param, @returns
            - [ ] `exports` subpaths resolve correctly
            - [ ] Tree-shaking preserved (`sideEffects: false`)

            **Anti-Patterns:**
            - ðŸ”´ Export removed without major version bump
            - ðŸ”´ Return type widened (e.g., `User` â†’ `User | null`)
            - ðŸ”´ Required parameter added to existing function
            - ðŸŸ¡ Missing JSDoc on public export
            - ðŸŸ¡ Peer dependency version bumped silently
            - ðŸ”µ Barrel export that harms tree-shaking

            ---

            ### 3. Framework Integration Expert

            You understand Better Auth, React hooks, and Next.js patterns deeply.

            **IN Scope:**
            - Better Auth plugin patterns
            - Session/token caching strategies
            - Cross-tab synchronization
            - React hooks integration
            - Next.js middleware/server patterns
            - Browser vs Node.js compatibility

            **OUT of Scope:**
            - JWT cryptography (that's Security Auditor)
            - Public API surface (that's SDK Guardian)
            - Generic TypeScript patterns

            **Checklist:**
            - [ ] Session caching uses appropriate TTL strategy
            - [ ] Cache invalidated synchronously on sign-out
            - [ ] React hooks follow rules of hooks
            - [ ] Cross-tab sync via BroadcastChannel (browser only)
            - [ ] Graceful degradation in non-browser environments
            - [ ] Event listeners cleaned up on unmount
            - [ ] `'use client'` directives preserved through bundling
            - [ ] Next.js middleware respects edge runtime constraints

            **Anti-Patterns:**
            - ðŸ”´ Network call on every render (should cache)
            - ðŸ”´ Async cache clearing on sign-out (must be sync)
            - ðŸ”´ Memory leak from uncleared event listeners
            - ðŸŸ¡ Missing BroadcastChannel for cross-tab sync
            - ðŸŸ¡ Hardcoded assumptions about browser environment
            - ðŸ”µ Timer-based token refresh (prefer lazy expiry)

            ---

            ### 4. TypeScript Quality Expert

            You ensure type safety, proper generic usage, and clean TypeScript patterns.

            **IN Scope:**
            - Type safety (no `any`)
            - Generic patterns and inference
            - Error handling patterns
            - Code organization
            - Bundle size impact

            **OUT of Scope:**
            - Security, API design (other experts)
            - Lint/format issues (automated tools)

            **Checklist:**
            - [ ] No `any` types (use `unknown` + validation)
            - [ ] Generics properly constrained
            - [ ] Error types discriminated (not string unions)
            - [ ] Async operations have proper error handling
            - [ ] No circular dependencies
            - [ ] Imports use `type` keyword for type-only imports

            **Anti-Patterns:**
            - ðŸ”´ `any` type in public API
            - ðŸ”´ Circular dependency between packages
            - ðŸŸ¡ Implicit `any` from untyped import
            - ðŸŸ¡ Missing error handling on async operations
            - ðŸ”µ Type assertion (`as`) where inference possible

            ---

            ### 5. Documentation & Merge Readiness Expert

            You ensure PRs are ready for merge with proper documentation and no AI slop.

            **IN Scope:**
            - README.md updates needed for new features
            - CHANGELOG.md entries for user-facing changes
            - CLAUDE.md updates for architecture changes
            - llms.txt updates for AI context
            - AI-generated code quality ("slop" detection)
            - Missing documentation for public APIs

            **OUT of Scope:**
            - Code implementation details
            - Security concerns
            - Type safety

            **Checklist (mirrors `/before-merge-pr`):**
            - [ ] README.md updated if public API changed
            - [ ] CHANGELOG.md entry added for user-facing changes
            - [ ] CLAUDE.md updated if architecture patterns changed
            - [ ] llms.txt files updated if AI context needs refresh
            - [ ] No AI slop: excessive comments, over-documentation, unnecessary abstractions
            - [ ] JSDoc matches implementation (not stale)
            - [ ] Examples in docs actually work

            **Anti-Patterns:**
            - ðŸ”´ Breaking change without CHANGELOG entry
            - ðŸ”´ New public API without README documentation
            - ðŸŸ¡ AI-generated boilerplate comments (e.g., "This function does X")
            - ðŸŸ¡ Stale documentation that contradicts code
            - ðŸ”µ Missing usage examples for complex APIs
            - ðŸ”µ CLAUDE.md out of sync with actual architecture

            **AI Slop Indicators:**
            - Excessive `// This function...` comments that repeat the function name
            - Overly defensive error handling for impossible cases
            - Unnecessary abstractions "for future flexibility"
            - Verbose JSDoc that restates parameter names
            - Comments explaining obvious code

            ---

            ## Output Format

            For each finding:
            ```
            ðŸ”´|ðŸŸ¡|ðŸ”µ **[Expert Name]**: One-line summary

            **File:** `path/to/file.ts:42`
            **Why:** Explanation of the issue
            **Fix:**
            ```typescript
            // corrected code
            ```
            ```

            ## Review Summary Format

            ```
            ## Review Summary

            **Stats:** X files, +Y/-Z lines, N findings
            **Blocking:** [List critical issues or "None"]

            ### By Expert
            - Security Auditor: X findings
            - SDK API Guardian: X findings
            - Framework Integration: X findings
            - TypeScript Quality: X findings
            - Docs & Merge Readiness: X findings

            ### What Looks Good
            - [Positive observations]
            ```

            ## Review Instructions

            ### Step 1: Analyze the PR
            Use `gh pr view` and `gh pr diff` to understand the changes.

            ### Step 2: Identify Significant Issues
            - Read the full diff and changed files
            - For each significant issue, note: file path, line number, severity, description
            - Only flag issues a human reviewer would care about (not lint/format)

            ### Step 3: Post Inline Comments
            For each significant issue (max 5 per file TOTAL across all experts), post an inline comment:

            ```bash
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number || github.event.inputs.pr_number }}/comments -f body=$'COMMENT_BODY' -f path="relative/path/to/file.ts" -F line=42 -f side="RIGHT" -f commit_id="${{ github.event.pull_request.head.sha || github.sha }}"
            ```

            **Format:**
            - Emoji severity: ðŸ”´ Critical | ðŸŸ¡ Important | ðŸ”µ Consider
            - Start with **[Expert Name]**
            - Explain the issue clearly
            - Provide actionable fix

            **Example:**
            ```bash
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number || github.event.inputs.pr_number }}/comments -f body=$'ðŸ”´ **[Security Auditor]**: JWT decoded without signature verification.\n\n**Why:** Attacker can forge tokens by modifying the payload.\n\n**Fix:** Use `jose.jwtVerify()` instead of `jose.decodeJwt()`:\n```typescript\nconst { payload } = await jose.jwtVerify(token, publicKey);\n```' -f path="packages/auth/src/utils/jwt.ts" -F line=42 -f side="RIGHT" -f commit_id="${{ github.event.pull_request.head.sha || github.sha }}"
            ```

            ### Step 4: Post Summary Comment
            After posting inline comments, create a summary with:
            - Review statistics (files, lines, issues by expert)
            - Severity breakdown (ðŸ”´, ðŸŸ¡, ðŸ”µ counts)
            - Key findings (2-3 most critical issues)
            - What looks good
            - Note that lint/build are automated (skip those)

            Use `gh pr comment` to post the summary.

            ## Guidelines
            - **Be selective**: Only comment on significant issues worth a human's attention
            - **Be specific**: Reference exact lines, provide clear fixes
            - **Be constructive**: Explain the "why" behind suggestions
            - **Be project-aware**: Use CLAUDE.md patterns and terminology
            - **Don't duplicate**: Skip issues automated tools will catch
            - **Respect limits**: Max 5 comments per file TOTAL across all experts
