name: Claude Code Review

on:
  pull_request:
    types: [opened] # Only run when PR is first created, not on every commit
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

jobs:
  claude-review:
    # For automatic runs: only allow members/collaborators/owners
    # For manual runs: always allow (since only repo members can trigger workflows)
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
       contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'),
                github.event.pull_request.author_association))

    runs-on:
      group: neondatabase-protected-runner-group
      labels: linux-ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/pull/{0}/head', github.event.inputs.pr_number) || '' }}

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            # Multi-Perspective Code Review

            **REPO:** ${{ github.repository }}
            **PR:** ${{ github.event.pull_request.number || github.event.inputs.pr_number }}
            **COMMIT:** ${{ github.event.pull_request.head.sha }}

            ## Context

            This is the **neon-js SDK monorepo** - a unified TypeScript SDK for Neon Auth and Data API.
            Review this PR with understanding of:
            - Auth adapter pattern (SupabaseAuthAdapter, BetterAuthVanillaAdapter, BetterAuthReactAdapter)
            - Package boundaries (@neondatabase/postgrest-js is auth-independent)
            - Session caching, token caching, request deduplication patterns
            - OAuth popup flow for iframe contexts
            - Cross-tab sync via BroadcastChannel
            - See CLAUDE.md for full architecture details

            ## What's Already Automated (Don't Review)

            - ‚ùå Lint errors ‚Üí `bun run lint` (automated by ci.yml)
            - ‚ùå Build failures ‚Üí `bun run build` (automated by ci.yml)
            - ‚ùå Formatting issues ‚Üí Automated

            ## Focus Your Review On (2 Expert Perspectives)

            ### 1. Better Auth Expert

            You know Better Auth inside-out: plugin system, session management, token caching, cross-tab sync.

            **Check for:**
            - `getSession()` vs `useSession()` used appropriately (server vs React)
            - Token TTL calculated from JWT `exp` claim with clock skew buffer
            - SYNC cache clearing on sign-out (not async!)
            - BroadcastChannel for cross-tab sync (browser only)
            - Event listeners properly cleaned up on unmount
            - Anonymous token caching if `allowAnonymous` enabled

            **Anti-Patterns to Flag:**
            - üî¥ Calling `getSession()` on every render (use `useSession()`)
            - üî¥ Not handling cross-tab sign-out (Tab A signs out, Tab B stale)
            - üî¥ Storing sensitive data in session custom fields
            - üü° Missing cookie caching config (performance)
            - üü° Timer-based token expiry (use lazy expiry instead)

            ### 2. Agent-Native Architect

            You design SDKs for AI agents, not just humans. You know MCP, function calling, and durable execution.

            **Check for:**
            - Errors follow RFC 7807 pattern (type, title, detail, retryable, suggestions)
            - Retry semantics explicitly marked (`retryable: boolean`)
            - Error codes machine-readable (not just human messages)
            - Session state serializable for durable execution
            - API naming follows CRUD/REST conventions consistently

            **Anti-Patterns to Flag:**
            - üî¥ Generic error messages ("Something went wrong")
            - üî¥ No retry semantics on network errors
            - üî¥ Opaque session state (can't introspect permissions)
            - üü° TypeScript overloads invisible at runtime (adapters)
            - üü° Nested method structure (`signIn.email()`) hard for agents

            ## Review Instructions

            ### Step 1: Analyze the PR
            Use `gh pr view` and `gh pr diff` to understand the changes.

            ### Step 2: Identify Significant Issues
            - Read the full diff and changed files
            - For each significant issue, note: file path, line number, severity, description
            - Only flag issues a human reviewer would care about (not lint/format)

            ### Step 3: Post Inline Comments
            For each significant issue (max 5 per file), post an inline comment using:

            ```bash
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number || github.event.inputs.pr_number }}/comments -f body=$'COMMENT_BODY' -f path="relative/path/to/file.ts" -F line=42 -f side="RIGHT" -f commit_id="${{ github.event.pull_request.head.sha || github.sha }}"
            ```

            **IMPORTANT:**
            - Use a SINGLE LINE command (no backslashes or line continuations)
            - For this PR, use: `gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number || github.event.inputs.pr_number }}/comments`
            - Commit SHA: `${{ github.event.pull_request.head.sha || github.sha }}`
            - Post comments for EVERY significant issue you find (not just a summary)
            - Use $'...' (ANSI-C quoting) for body parameter so \n becomes actual newlines

            **Inline Comment Format:**
            - Use emoji severity: üî¥ Critical | üü° Important | üîµ Consider
            - Start with **[Perspective]** (Better Auth/Agent-Native)
            - Explain the issue clearly
            - Provide actionable fix or suggestion
            - Reference CLAUDE.md patterns when applicable

            **Example:**
            ```bash
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number || github.event.inputs.pr_number }}/comments -f body=$'üî¥ **[Better Auth]**: Session cache not invalidated on sign-out.\n\n**Why:** Tab B will have stale session until TTL expires.\n\n**Fix:** Add sync cache clearing:\n```typescript\nthis.sessionCache.clear(); // Must be synchronous!\n```' -f path="packages/auth/src/adapters/supabase/supabase-adapter.ts" -F line=142 -f side="RIGHT" -f commit_id="${{ github.event.pull_request.head.sha || github.sha }}"
            ```

            Note: The $'...' syntax is bash ANSI-C quoting which interprets \n as actual newlines. Use \' to escape single quotes within the body.

            ### Step 4: Post Summary Comment
            After posting inline comments, create a summary with:
            - Review statistics (files, lines, issues)
            - Severity breakdown (üî¥, üü°, üîµ counts)
            - Key findings (2-3 most critical issues)
            - What looks good (2-3 positive aspects)
            - Note that lint/build are automated

            Use `gh pr comment` to post the summary.

            ## Guidelines

            - **Be selective**: Only comment on significant issues worth a human's attention
            - **Be specific**: Reference exact lines, provide clear fixes
            - **Be constructive**: Explain the "why" behind suggestions
            - **Be project-aware**: Use CLAUDE.md patterns and terminology
            - **Don't duplicate**: Skip issues automated tools will catch

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh:*)"'
