name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

  # Cross-repo trigger: Allow external repos to run E2E tests
  # Used by Neon Auth service to validate changes don't break the SDK
  repository_dispatch:
    types: [run-e2e]

  # Manual trigger with optional ref, environment, and app override
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to test (branch, tag, or SHA)'
        required: false
        default: 'main'
      environment:
        description: 'Neon environment to test against'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - preview
      app:
        description: 'Example app to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - react-neon-js
          - nextjs-neon-auth

# SECURITY: Limit permissions to minimum required
permissions:
  contents: read

jobs:
  # Validation job: Validates and sanitizes inputs for dispatch events
  validate:
    runs-on: ubuntu-latest
    # Skip validation for push/PR events (they don't have dispatch payloads)
    if: github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'
    outputs:
      environment: ${{ steps.validate.outputs.environment }}
    steps:
      - name: Audit log entry
        run: |
          echo "## E2E Dispatch Audit" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Event:** ${{ github.event_name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Run ID:** ${{ github.run_id }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Validate and extract inputs
        id: validate
        env:
          INPUT_ENV: ${{ github.event.client_payload.environment || github.event.inputs.environment || 'production' }}
          INPUT_SOURCE_REPO: ${{ github.event.client_payload.source_repo }}
        run: |
          # Log source repo for audit trail
          if [[ -n "$INPUT_SOURCE_REPO" ]]; then
            echo "- **Source repo:** $INPUT_SOURCE_REPO" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Validate environment against allowed values (only needed for repository_dispatch)
          if [[ ! "$INPUT_ENV" =~ ^(production|staging|preview)$ ]]; then
            echo "::error::Invalid environment: $INPUT_ENV. Must be production, staging, or preview"
            exit 1
          fi
          echo "environment=$INPUT_ENV" >> "$GITHUB_OUTPUT"
          echo "- **Environment:** $INPUT_ENV" >> "$GITHUB_STEP_SUMMARY"

  e2e:
    needs: [validate]
    # Run if:
    # - Push/PR events (no validate job ran, needs.validate is skipped)
    # - Dispatch events where validation passed
    if: |
      always() && (
        github.event_name == 'push' ||
        github.event_name == 'pull_request' ||
        needs.validate.result == 'success'
      )
    timeout-minutes: 20
    runs-on:
      group: neondatabase-protected-runner-group
      labels: linux-ubuntu-latest

    # Matrix strategy: test both example apps in parallel
    strategy:
      fail-fast: false
      matrix:
        app:
          - react-neon-js
          - nextjs-neon-auth
        exclude:
          # Exclude apps not matching the input when a specific app is requested
          - app: ${{ (github.event.inputs.app != 'all' && github.event.inputs.app != 'react-neon-js' && github.event.inputs.app != '') && 'react-neon-js' || 'never-exclude' }}
          - app: ${{ (github.event.inputs.app != 'all' && github.event.inputs.app != 'nextjs-neon-auth' && github.event.inputs.app != '') && 'nextjs-neon-auth' || 'never-exclude' }}

    # Use GitHub Environments for environment-specific secrets/variables
    # - production: Default, uses production Neon API
    # - staging: Uses staging Neon API (console.stage.neon.tech)
    # - preview: Uses preview Neon API
    environment: ${{ needs.validate.outputs.environment || 'production' }}

    # Concurrency: prevent duplicate runs per app, but don't cancel external triggers
    concurrency:
      group: e2e-${{ matrix.app }}-${{ github.event_name == 'repository_dispatch' && github.run_id || github.head_ref || github.ref }}
      cancel-in-progress: ${{ github.event_name != 'repository_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use ref from dispatch events, otherwise default behavior
          ref: ${{ github.event.client_payload.ref || inputs.ref || '' }}
          # Security: don't persist git creds for normal triggers.
          # For repository_dispatch (cross-repo), we must persist credentials because
          # the cleanup phase fails with the cross-repo token context.
          # This is safe: no subsequent step uses git, and the runner is ephemeral.
          persist-credentials: ${{ github.event_name == 'repository_dispatch' }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Restore build cache
        id: build-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            packages/internal/dist
            packages/postgrest-js/dist
            packages/auth-ui/dist
            packages/auth/dist
            packages/neon-js/dist
          key: build-${{ runner.os }}-${{ hashFiles('packages/*/src/**', 'packages/*/tsdown.config.ts', 'build/**', 'tsconfig.json') }}
          restore-keys: |
            build-${{ runner.os }}-

      - name: Build packages
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: bun run build

      # Create an isolated Neon branch for this PR/run
      - name: Get branch expiration date (2 hours from now)
        run: echo "EXPIRES_AT=$(date -u --date '+2 hours' +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"

      - name: Create Neon branch
        id: create-branch
        uses: neondatabase/create-branch-action@v6
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: test-${{ matrix.app }}-${{ github.run_id }}-${{ github.run_attempt }}
          api_key: ${{ secrets.NEON_API_KEY }}
          # api_host: Empty for production (uses default), set per-environment for staging/preview
          api_host: ${{ vars.NEON_API_HOST }}
          get_auth_url: true
          get_data_api_url: true
          expires_at: ${{ env.EXPIRES_AT }}

      # Build React example (uses VITE_ prefix)
      - name: Build React example app
        if: matrix.app == 'react-neon-js'
        run: cd examples/react-neon-js && bun run build
        env:
          VITE_NEON_AUTH_URL: ${{ steps.create-branch.outputs.auth_url }}
          VITE_NEON_DATA_API_URL: ${{ steps.create-branch.outputs.data_api_url }}

      # Build Next.js example (uses NEON_AUTH_BASE_URL)
      - name: Build Next.js example app
        if: matrix.app == 'nextjs-neon-auth'
        run: cd examples/nextjs-neon-auth && bun run build
        env:
          NEON_AUTH_BASE_URL: ${{ steps.create-branch.outputs.auth_url }}

      # Get Playwright version for cache key
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(cd e2e && bunx playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      # Cache browser binaries with restore-keys fallback
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
          restore-keys: |
            playwright-chromium-${{ runner.os }}-

      # Install browsers only on cache miss
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd e2e && bunx playwright install --with-deps chromium

      # Install system deps if browsers were cached (they may need system libs)
      - name: Install system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: cd e2e && bunx playwright install-deps chromium

      - name: Run E2E tests
        run: |
          if [ "${{ matrix.app }}" = "react-neon-js" ]; then
            bun run --filter e2e test:react:ci
          else
            bun run --filter e2e test:nextjs:ci
          fi
        env:
          CI: true
          E2E_TARGET_APP: ${{ matrix.app }}

      # Clean up: Delete Neon branch (runs even if tests fail)
      - name: Delete Neon branch
        if: always()
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: test-${{ matrix.app }}-${{ github.run_id }}-${{ github.run_attempt }}
          api_key: ${{ secrets.NEON_API_KEY }}
          api_host: ${{ vars.NEON_API_HOST }}

      # Upload HTML report (always, for debugging)
      - name: Upload test report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.app }}
          path: e2e/playwright-report/
          retention-days: 7

      # Upload screenshots/traces only on failure
      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-${{ matrix.app }}
          path: e2e/test-results/
          retention-days: 3
